<os-head-bar
    [hasMainButton]="perms.isAllowed('can_create_amendments', motion)"
    mainActionTooltip="New amendment"
    prevUrl="../.."
    [nav]="false"
    [editMode]="editMotion"
    (mainEvent)="createAmendment()"
    (cancelEditEvent)="leaveEditMotion()"
    (saveEvent)="saveMotion()"
>
    <!-- Title -->
    <div class="title-slot">
        <h2 *ngIf="motion && !newMotion">
            <span>{{ 'Motion' | translate }}</span>
            <!-- Whitespace between "Motion" and number -->
            <span>&nbsp;</span> <span *ngIf="!editMotion">{{ motion.number }}</span>
            <!-- <span *ngIf="editMotion">{{ contentForm.get('number').value }}</span> -->
        </h2>
        <h2 *ngIf="newMotion && !amendmentEdit">{{ 'New motion' | translate }}</h2>
        <h2 *ngIf="amendmentEdit">{{ 'New amendment' | translate }}</h2>
    </div>

    <!-- Back and forth buttons -->
    <div *ngIf="!editMotion && !vp.isMobile" class="extra-controls-slot prev-next-motion-controls">
        <div *ngIf="previousMotion">
            <button mat-button (click)="navigateToMotion(previousMotion)">
                <os-icon-container icon="chevron_left">
                    {{ previousMotion.number }}
                </os-icon-container>
            </button>
        </div>
        <div *ngIf="nextMotion">
            <button mat-button (click)="navigateToMotion(nextMotion)">
                <os-icon-container icon="chevron_right" [swap]="true">
                    {{ nextMotion.number }}
                </os-icon-container>
            </button>
        </div>
    </div>

    <!-- Menu -->
    <div class="menu-slot">
        <button type="button" mat-icon-button [matMenuTriggerFor]="motionExtraMenu">
            <mat-icon>more_vert</mat-icon>
        </button>
    </div>

    <mat-menu #motionExtraMenu="matMenu">
        <div *ngIf="motion">
            <div *ngIf="vp.isMobile">
                <button mat-menu-item (click)="navigateToMotion(previousMotion)" *ngIf="previousMotion">
                    <mat-icon>chevron_left</mat-icon>
                    <span>{{ 'Motion' | translate }} {{ previousMotion.number }}</span>
                </button>
                <button mat-menu-item (click)="navigateToMotion(nextMotion)" *ngIf="nextMotion">
                    <mat-icon>chevron_right</mat-icon>
                    <span>{{ 'Motion' | translate }} {{ nextMotion.number }}</span>
                </button>
                <mat-divider *ngIf="previousMotion || nextMotion"></mat-divider>
            </div>
            <!-- List of speakers -->
            <os-speaker-button [object]="motion" [menuItem]="true"></os-speaker-button>
            <!-- PDF -->
            <button mat-menu-item (click)="onDownloadPdf()">
                <mat-icon>picture_as_pdf</mat-icon>
                <span>{{ 'PDF' | translate }}</span>
            </button>
            <mat-divider
                *osPerms="[
                    permission.projectorCanManage,
                    permission.agendaItemCanManage,
                    permission.meetingCanSeeHistory
                ]"
            ></mat-divider>
            <!-- Project -->
            <os-projector-button
                [object]="motion"
                [menuItem]="true"
                *osPerms="permission.projectorCanManage"
            ></os-projector-button>
            <!-- Add/remove to/from agenda -->
            <div *osPerms="permission.agendaItemCanManage">
                <button mat-menu-item (click)="addToAgenda()" *ngIf="motion && !motion.agenda_item_id">
                    <mat-icon>add</mat-icon>
                    <span>{{ 'Add to agenda' | translate }}</span>
                </button>
                <button mat-menu-item (click)="removeFromAgenda()" *ngIf="motion && motion.agenda_item_id">
                    <mat-icon>remove</mat-icon>
                    <span>{{ 'Remove from agenda' | translate }}</span>
                </button>
            </div>
            <button
                mat-menu-item
                *osPerms="permission.meetingCanSeeHistory"
                [routerLink]="['/history']"
                [queryParams]="{ element: motion.fqid }"
            >
                <mat-icon>history</mat-icon>
                <span>
                    {{ 'History' | translate }}
                </span>
            </button>
            <mat-divider *ngIf="perms.isAllowed('update', motion) || perms.isAllowed('manage')"></mat-divider>
            <!-- Edit-->
            <button mat-menu-item (click)="enterEditMotion()" *ngIf="perms.isAllowed('update', motion)">
                <mat-icon>edit</mat-icon>
                <span>{{ 'Edit' | translate }}</span>
            </button>
            <!-- Delete -->
            <button
                mat-menu-item
                class="red-warning-text"
                (click)="deleteMotionButton()"
                *ngIf="perms.isAllowed('manage')"
            >
                <mat-icon>delete</mat-icon>
                <span>{{ 'Delete' | translate }}</span>
            </button>
        </div>
    </mat-menu>
</os-head-bar>

<div class="content-container spacer-bottom-60" (touchstart)="swipe($event, 'start')" (touchend)="swipe($event, 'end')">
    <!-- Title -->
    <div class="title" *ngIf="motion && !editMotion">
        <os-motion-manage-title [motion]="motion" [crMode]="crMode"></os-motion-manage-title>
    </div>

    <ng-container *ngIf="vp.isMobile; then mobileView; else desktopView"></ng-container>
</div>

<ng-template #mobileView>
    <div *ngIf="motion" class="mobile-view">
        <!-- Meta info -->
        <div><ng-container *ngTemplateOutlet="metaInfoTemplate"></ng-container></div>

        <!-- Content -->
        <mat-card [ngClass]="editMotion ? 'os-form-card-mobile' : 'os-card'">
            <os-motion-content
                [motion]="motion"
                [editMotion]="editMotion"
                [newMotion]="newMotion"
                (save)="saveMotion($event)"
            ></os-motion-content>
        </mat-card>

        <!-- Comments -->
        <os-motion-comments *ngIf="!editMotion" [motion]="motion"></os-motion-comments>

        <!-- Personal note -->
        <os-personal-note *ngIf="!editMotion && !operator.isAnonymous" [motion]="motion"></os-personal-note>
    </div>
</ng-template>

<ng-template #desktopView>
    <div class="desktop-view" *ngIf="motion || newMotion">
        <div class="desktop-left">
            <!-- Meta Info -->
            <div *ngIf="!newMotion && !editMotion">
                <ng-container *ngTemplateOutlet="metaInfoTemplate"></ng-container>
            </div>

            <os-motion-comments *ngIf="!editMotion" [motion]="motion"></os-motion-comments>
            <os-personal-note *ngIf="!editMotion && !operator.isAnonymous" [motion]="motion"></os-personal-note>
        </div>
        <div class="desktop-right">
            <!-- Content -->
            <mat-card [ngClass]="editMotion ? 'os-form-card' : 'os-card'">
                <os-motion-highlight-form
                    #highlightForm
                    *ngIf="!newMotion && !editMotion"
                    [motion]="motion"
                    (changeChangeRecoMode)="crMode = $event"
                    (changeLineNumberingMode)="lnMode = $event"
                ></os-motion-highlight-form>
                <os-motion-content
                    #content
                    [motion]="motion"
                    [editMotion]="editMotion"
                    [newMotion]="newMotion"
                    [lnMode]="lnMode"
                    [changeRecoMode]="crMode"
                    (save)="saveMotion($event)"
                    (changeForm)="temporaryMotion = $event"
                ></os-motion-content>
            </mat-card>
        </div>
    </div>
</ng-template>

<ng-template #metaInfoTemplate>
    <div>
        <os-motion-meta-data [motion]="motion"></os-motion-meta-data>
    </div>
</ng-template>

<!-- Line number Menu -->
<!-- <mat-menu #lineNumberingMenu="matMenu">
    <div *ngIf="motion">
        <button
            mat-menu-item
            (click)="setLineNumberingMode(LineNumberingMode.None)"
            [ngClass]="{ selected: lnMode === LineNumberingMode.None }"
        >
            {{ 'none' | translate }}
        </button>
        <button
            mat-menu-item
            (click)="setLineNumberingMode(LineNumberingMode.Inside)"
            [ngClass]="{ selected: lnMode === LineNumberingMode.Inside }"
        >
            {{ 'inline' | translate }}
        </button>
        <button
            mat-menu-item
            (click)="setLineNumberingMode(LineNumberingMode.Outside)"
            [ngClass]="{ selected: lnMode === LineNumberingMode.Outside }"
        >
            {{ 'outside' | translate }}
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item *ngIf="!highlightedLineOpened" (click)="highlightedLineOpened = true">
            <mat-icon>redo</mat-icon>
            <span>{{ 'Go to line' | translate }}</span>
        </button>
    </div>
</mat-menu> -->

<!-- Diff View Menu
     For motions, all items are available if there are changing objects. The final print template only after is has been created.
     For paragraph-based amendments, only the original and the diff version is available.
-->
<!-- <mat-menu #changeRecoMenu="matMenu">
    <button
        mat-menu-item
        (click)="setChangeRecoMode(ChangeRecoMode.Original)"
        [ngClass]="{ selected: crMode === ChangeRecoMode.Original }"
    >
        {{ 'Original version' | translate }}
    </button>
    <button
        mat-menu-item
        (click)="setChangeRecoMode(ChangeRecoMode.Changed)"
        [ngClass]="{ selected: crMode === ChangeRecoMode.Changed }"
        *ngIf="hasChangingObjects()"
    >
        {{ 'Changed version' | translate }}
    </button>
    <button
        mat-menu-item
        (click)="setChangeRecoMode(ChangeRecoMode.Diff)"
        [ngClass]="{ selected: crMode === ChangeRecoMode.Diff }"
        *ngIf="hasChangingObjects()"
    >
        {{ 'Diff version' | translate }}
    </button>
    <button
        mat-menu-item
        (click)="setChangeRecoMode(ChangeRecoMode.Final)"
        [ngClass]="{ selected: crMode === ChangeRecoMode.Final }"
        *ngIf="motion && !motion.isParagraphBasedAmendment() && hasChangingObjects()"
    >
        {{ 'Final version' | translate }}
    </button>
    <button
        mat-menu-item
        *ngIf="motion && motion.modified_final_version && !motion.isParagraphBasedAmendment()"
        (click)="setChangeRecoMode(ChangeRecoMode.ModifiedFinal)"
        [ngClass]="{ selected: crMode === ChangeRecoMode.ModifiedFinal }"
    >
        {{ 'Final print template' | translate }}
    </button>
</mat-menu> -->
